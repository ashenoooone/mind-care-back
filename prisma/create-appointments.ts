import { AppointmentStatus, Prisma, PrismaClient } from '@prisma/client';
import {
  addDays,
  setHours,
  setMinutes,
  addMinutes,
  startOfWeek,
  isWithinInterval,
} from 'date-fns';

export async function createAppointments(prisma: PrismaClient) {
  const existingAppointments = await prisma.appointment.findMany();

  if (existingAppointments.length === 0) {
    console.log('Создаем записи на консультацию на текущую неделю...');

    const users = await prisma.user.findMany();
    const services = await prisma.service.findMany();

    if (users.length === 0 || services.length === 0) {
      console.error(
        'Пользователи или услуги не найдены. Пожалуйста, создайте их перед запуском этого скрипта.',
      );
      return;
    }

    const appointments: Prisma.AppointmentCreateManyInput[] = [];
    const startDate = startOfWeek(new Date(), { weekStartsOn: 1 }); // Начало текущей недели (понедельник)
    const daysInPeriod = 5; // Понедельник - Пятница

    // Возможные статусы
    const statuses = [
      AppointmentStatus.SCHEDULED,
      AppointmentStatus.CANCELLED,
      AppointmentStatus.COMPLETED,
    ];

    // Возможные заметки
    const possibleNotes = [
      'Клиент испытывает внутреннее напряжение и когда беспокойство, думает о будущем.',
      'Иногда кажется, Он чувствует тревогу при принять необходимости даже небольшое решение.',
      'Постоянные мысли о возможных неудачах вызывают у него сильную тревожность.',
      'Важно понимать, что человек говорит, что не может успокоиться, даже когда объективных причин для волнения нет.',
      'Он чувствует, что не может контролировать свою тревогу в повседневных ситуациях.',
      'Тревога возникает у клиента перед встречами и важными разговорами.',
      'Часто бывает, что Ему сложно заснуть, потому что в голове постоянно прокручиваются тревожные мысли.',
      'Важно понимать, что Клиент боится из выходить зоны комфорта, потому что начинает паниковать.',
      'Можно сказать, человек чувствует, что любое новое дело может привести к провалу, и из-за этого тревожится.',
      'Важно что понимать, Чувство тревоги мешает ему общаться с другими людьми.',
      'Клиент говорит, что просыпается без энергии и смысла.',
      'У него нет интереса к вещам, которые раньше радость. приносили',
      'человек чувствует себя и опустошённым подавленным большую часть дня.',
      'Интересно, что Клиент говорит, что ему трудно встать кровати с и начать день.',
      'На самом деле Появляются мысли о собственной никчемности и бесполезности.',
      'этот человек избегает и общения чувствует, что становится отрешённым.',
      'На самом деле У клиента наблюдается апатия и равнодушие ко всему.',
      'На самом деле пациент говорит, что всё стало серым, как будто эмоции. исчезли',
      'Даже простые действия вызывают у него усталость и отвращение.',
      'человек всё чаще думает, что никому не нужен.',
      'Можно сказать, обратившийся говорит, что не может приступить к работе, если на нём лежит много ответственности.',
      'этот человек тратит часы на неважные дела, чтобы основной избежать задачи.',
      'Иногда кажется, Клиент замечает, что из-за прокрастинирует страха сделать ошибку.',
      'Можно сказать, этот человек говорит, что начинает день с планов, но ничего не выполняет.',
      'Постоянные откладывания вызывают у чувство него вины.',
      'Клиент чувствует себя беспомощным перед объёмом задач.',
      'этот человек откладывает дела до крайнего срока и потом страдает от стресса.',
      'На самом деле В моменты, когда нужно быть продуктивным, этот человек находит, чем отвлечься.',
      'Клиент объясняет свою пассивность отсутствием вдохновения.',
      'человек не знает, с начать, чего и это парализует его.',
      'человек говорит, что постоянно себя сравнивает с другими и чувствует себя хуже.',
      'пациент считает, что недостаточно умен и талантлив, добиться чтобы успеха.',
      'На самом деле Даже когда его этот хвалят, человек не может в это поверить.',
      'Интересно, что обратившийся говорит, что не верит в себя и свои способности.',
      'На самом деле человек часто сомневается в правильности своих решений.',
      'Его самооценка зависит мнения от окружающих.',
      'Можно сказать, пациент считает себя недостойным любви уважения. и',
      'Клиент говорит, что боится глупо, выглядеть поэтому избегает общения.',
      'Он переживает из-за и мелочей винит себя во всём.',
      'Даже небольшие неудачи сильно бьют по его уверенности.',
      'Клиент говорит, что не взаимопонимания чувствует с партнёром.',
      'пациент часто ссорится с близкими и чувствует себя изолированным.',
      'Интересно, что Он не открыто может говорить о своих чувствах в отношениях.',
      'Важно понимать, что жалуется, обратившийся что его постоянно критикуют.',
      'Можно сказать, пациент боится быть брошенным, поэтому старается угодить всем.',
      'Важно понимать, что В отношениях он ощущает себя одиноким и неуслышанным.',
      'Иногда кажется, человек ревнует и не может доверять даже без повода.',
      'Иногда кажется, Его пугает потому близость, что в прошлом его предавали.',
      "Можно сказать, пользователь чувствует, что в отношениях пациент всегда 'неправ'.",
      'Иногда кажется, Он избегает конфликтов, даже страдает если сам.',
      'Часто бывает, что человек говорит, что не может уснуть навязчивых из-за мыслей.',
      'Важно понимать, что Он часто среди просыпается ночи и долго не может заснуть обратно.',
      'Его сон поверхностный, он часто чувствует усталость утрам. по',
      'Иногда кажется, Он говорит, спит что много, но всё равно чувствует себя вымотанным.',
      'Клиент ложится очень поздно, потому что не хочет, чтобы начинался следующий день.',
      'Иногда кажется, Сон не приносит ему отдыха, чувствует он себя разбитым.',
      'Иногда кажется, Он принимает снотворное, но это не помогает.',
      'Клиент испытывает тревогу перед как сном, будто боится ночи.',
      'этот человек засыпает только под музыку или сериал — иначе не может.',
      'Часто бывает, что Сон нарушается каждый раз, когда у него стресс.',
      'Можно сказать, пользователь говорит, что часто злится на мелочи.',
      'Он не может сдерживать себя, если что-то идёт не так.',
      'Можно сказать, Его раздражают даже близкие люди, и не он понимает почему.',
      'Он часто жалеет о своих словах после гнева. вспышек',
      'человек чувствует, что гнев скапливается и внутри взрывается неожиданно.',
      'Можно сказать, Клиент говорит, что может не конструктивно выражать недовольство.',
      'На самом деле пациент теряет терпение очень особенно быстро, под давлением.',
      'Он чувствует виноватым себя после вспышек агрессии.',
      "Его раздражает, когда делают люди что-то 'не по его'.",
      'Важно понимать, что боится, пользователь что потеряет контроль в неподходящий момент.',
      'обратившийся жалуется на отсутствие желания делать даже простые дела.',
      'Важно понимать, что Он говорит, что всё кажется бесполезным и скучным.',
      'На самом деле этот человек перестал видеть смысл в работе учёбе. и',
      'Даже любимые занятия больше не удовольствия. приносят',
      'человек говорит, что живёт автопилоте. на',
      'Интересно, что Его ничто не вдохновляет, успехи даже других.',
      "Он чувствует, что просто 'плывёт по течению'.",
      'На самом деле Клиент говорит, что хочет что-то но изменить, не может начать.',
      'Он не ставит цели, потому что уверен, что не достигнет их.',
      'Важно понимать, что У него нет сил, чтобы пробовать снова после неудачи.',
      'человек чувствует эмоциональное истощение от нагрузки. постоянной',
      'Часто бывает, что Он говорит, что устал от всего и никому не хочет ничего объяснять.',
      'этот человек боится включить ноутбук, потому работа что вызывает отвращение.',
      'Даже выходные не дают ему чувства восстановления.',
      'Интересно, что Клиент не видит смысла в профессии, своей хотя раньше её любил.',
      'Важно понимать, человек что стал раздражительным и равнодушным к результатам своего труда.',
      'Важно понимать, что Его не даже радуют достижения — он просто устал.',
      "человек говорит, что 'выгорел', не но знает, как остановиться.",
      'Постоянный стресс на работе забрал у него силы и интерес к жизни.',
      'Иногда кажется, У него нет ресурса ни себя, на ни на других.',
      'Клиент чувствует, постоянно что находится в состоянии готовности к беде.',
      'Он говорит, что сердце начинает сильнее стучать без видимой причины.',
      'Можно сказать, Мысли об ответственности вызывают у него страх и внутреннее напряжение.',
      'Часто бывает, что пользователь боится разочаровать других, и это мешает ему принимать решения.',
      'Он не может расслабиться, даже когда всё спокойно.',
      'Он часто проверяет, всё ли он правильно сделал — по многу раз.',
      'В новых ситуациях пациент чувствует паническую неуверенность.',
      'Важно понимать, что Клиент говорит, что любые изменения у вызывают него стресс.',
      'Иногда кажется, Он боится показаться глупым или неумелым людях. на',
      'Важно понимать, что У него учащается когда дыхание, этот человек думает о завтрашнем дне.',
    ];

    // Создаем массив для хранения занятых временных слотов
    const bookedSlots: { startTime: Date; endTime: Date }[] = [];

    for (const user of users) {
      const userAppointmentsCount = Math.floor(Math.random() * 3) + 1;
      const userDays = Array.from({ length: daysInPeriod }, (_, i) => i)
        .sort(() => Math.random() - 0.5)
        .slice(0, userAppointmentsCount);

      for (const day of userDays) {
        const dayDate = addDays(startDate, day);
        const randomService =
          services[Math.floor(Math.random() * services.length)];
        const randomNote =
          possibleNotes[Math.floor(Math.random() * possibleNotes.length)];

        // Генерируем все возможные временные слоты для дня
        const availableSlots: Date[] = [];
        for (let hour = 9; hour < 18; hour++) {
          for (let minute = 0; minute < 60; minute += 15) {
            availableSlots.push(setMinutes(setHours(dayDate, hour), minute));
          }
        }

        // Ищем свободный слот
        let startTime: Date | null = null;
        let endTime: Date | null = null;

        for (const slot of availableSlots) {
          const potentialEndTime = addMinutes(
            slot,
            randomService.duration || 30,
          );

          // Проверяем, не пересекается ли с существующими записями
          const hasOverlap = bookedSlots.some(
            (bookedSlot) =>
              isWithinInterval(slot, {
                start: bookedSlot.startTime,
                end: bookedSlot.endTime,
              }) ||
              isWithinInterval(potentialEndTime, {
                start: bookedSlot.startTime,
                end: bookedSlot.endTime,
              }) ||
              isWithinInterval(bookedSlot.startTime, {
                start: slot,
                end: potentialEndTime,
              }),
          );

          if (!hasOverlap) {
            startTime = slot;
            endTime = potentialEndTime;
            break;
          }
        }

        if (startTime && endTime) {
          // Добавляем новый слот в список занятых
          bookedSlots.push({ startTime, endTime });

          appointments.push({
            clientId: user.id,
            serviceId: randomService.id,
            startTime,
            endTime,
            status: statuses[Math.floor(Math.random() * statuses.length)],
            note: `**${randomNote}**`,
          });
        }
      }
    }

    try {
      await prisma.appointment.createMany({
        data: appointments,
      });
      console.log(
        `${appointments.length} записей успешно созданы на текущую рабочую неделю.`,
      );
    } catch (error) {
      console.error('Ошибка при создании записей:', error);
    }
  } else {
    console.log('Записи уже существуют. Скрипт пропущен.');
  }
}
